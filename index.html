<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Viewer — Pro</title>

  <!-- Import map for bare specifier "three" -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js"
    }
  }
  </script>

  <!-- FontAwesome icon font (used by inspector toggles) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- zip.js for performant, streaming ZIP processing -->
  <script src="https://unpkg.com/@zip.js/zip.js/dist/zip-full.min.js"></script>
  <!-- TGA-js - standalone TGA loader for browser -->
  <script src="/src/utils/tga-js.js"></script>
  <script>console.debug('[index.html] TGALoader global:', typeof TGALoader !== 'undefined');</script>

  <link rel="stylesheet" href="src/style.css" />
</head>
<body class="preload">
  <div class="viewer-wrap" id="drop-zone" aria-label="3D Viewer">
    <canvas class="viewer-canvas" id="viewport" tabindex="0" data-engine="three.js r152" style="touch-action: none;"></canvas>
  </div>

  <aside class="left-col" aria-label="Controls">
    <header>
      <span class="logo-dot" aria-hidden="true"></span>
      <h1 data-i="title">3D Viewer</h1>
      <select id="lang" class="field lang-select">
        <option value="en" data-i="lang_en">English</option>
        <option value="ru" data-i="lang_ru">Русский</option>
      </select>
      <button id="theme-toggle" class="theme-switch" title="Theme">
        <i class="fas fa-sun icon" id="theme-icon"></i>
      </button>
    </header>

    <div class="group">
      <div class="toolbar">
        <label class="btn btn-primary">
          <input id="file-input" type="file" accept=".gltf,.glb,.fbx,.obj,.bin,.dae,.vrm,.zip" hidden />
          <i class="fas fa-upload"></i>
          <span data-i="btnLoad">Load model</span>
        </label>
        <button id="clear-scene" class="btn danger btn-primary">
          <i class="fas fa-trash"></i>
          <span data-i="btnClear">Clear</span>
        </button>
      </div>

      <div class="split"></div>

      <div class="toolbar">
        <button id="reset-camera" class="btn secondary">
          <i class="fas fa-crosshairs"></i>
          <span data-i="btnFrame">Frame</span>
        </button>
        <button id="reset-all" class="btn secondary">
          <i class="fas fa-undo"></i>
          <span data-i="btnResetAll">Reset all</span>
        </button>
      </div>

      <div class="split"></div>

      <!-- Collapsible: Display -->
      <details class="section" data-sec="display" open>
        <summary><span class="summary-title"><i class="fas fa-eye"></i> <span data-i="displayTitle">Display</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label class="toggle"><input type="checkbox" id="toggle-shadows" /><i class="fas fa-sun"></i><span data-i="toggleShadows">Shadows</span></label>
            <label class="toggle"><input type="checkbox" id="toggle-fxaa" checked /><i class="fas fa-magic"></i><span data-i="toggleFXAA">FXAA</span></label>
            <label class="toggle"><input type="checkbox" id="toggle-lightonly" /><i class="fas fa-lightbulb"></i><span data-i="toggleLight">Light only</span></label>
            <label class="toggle"><input type="checkbox" id="toggle-grid" checked /><i class="fas fa-th"></i><span data-i="toggleGrid">Grid</span></label>
            <label class="toggle"><input type="checkbox" id="toggle-flipuv" /><i class="fas fa-arrows-alt-h"></i><span data-i="toggleFlipUV">Flip UV</span></label>
          </div>
        </div>
      </details>
  
      <!-- Collapsible: Background & HDRI -->
      <details class="section" data-sec="background">
        <summary><span class="summary-title"><i class="fas fa-image"></i> <span data-i="backgroundTitle">Background & HDRI</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="bgLabel">Background</label>
            <select id="bg-select" class="field">
              <option value="white" selected data-i="bgWhite">White</option>
              <option value="lightgray" data-i="bgLightGray">Light Gray</option>
              <option value="midgray" data-i="bgMidGray">Mid Gray</option>
              <option value="darkgray" data-i="bgDarkGray">Dark</option>
              <option value="transparent" data-i="bgTransparent">Transparent</option>
              <option value="custom" data-i="bgCustom">Custom</option>
            </select>
            <input id="bg-color" class="field" type="color" value="#ffffff" title="Custom" />
          </div>

          <div class="row">
            <label data-i="hdriLabel">HDRI</label>
            <input class="field" type="text" id="hdri-url" placeholder="URL .hdr" />
            <button id="apply-hdri" class="btn">
              <i class="fas fa-check"></i>
              <span data-i="btnApply">Apply</span>
            </button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Textures & Materials -->
      <details class="section" data-sec="materials">
        <summary><span class="summary-title"><i class="fas fa-palette"></i> <span data-i="materialsTitle">Textures & Materials</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="texturesLabel">Textures</label>
            <input id="texture-input" type="file" accept=".zip" hidden />
            <label for="texture-input" class="btn">
              <i class="fas fa-folder-open"></i>
              <span data-i="btnLoadTexturesText">Load textures</span>
            </label>
            <button id="apply-textures" class="btn">
              <i class="fas fa-check"></i>
              <span data-i="btnApply">Apply</span>
            </button>
          </div>

          <!-- Moved up: Material/Wireframe always visible -->
          <div class="row">
            <label data-i="matOverride">Material</label>
            <select id="mat-override" class="field">
              <option value="none" selected data-i="matOriginal">Original</option>
              <option value="standard" data-i="matStandard">Standard</option>
              <option value="phong" data-i="matPhong">Phong</option>
              <option value="basic" data-i="matBasic">Basic</option>
              <option value="normal" data-i="matNormal">Normal</option>
              <option value="toon" data-i="matToon">Toon</option>
            </select>
            <label class="toggle"><input type="checkbox" id="toggle-wireframe" /><i class="fas fa-project-diagram"></i><span data-i="wireframe">Wireframe</span></label>
          </div>
        </div>
      </details>


      <!-- Collapsible: Render -->
      <details class="section" data-sec="render">
        <summary><span class="summary-title"><i class="fas fa-paint-brush"></i> <span data-i="renderTitle">Render</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="exposureLabel">Exposure</label>
            <input id="exposure" class="range" type="range" min="0" max="4" step="0.01" value="1" />
            <span class="small" id="exposure-val">1.00</span>
          </div>
          <div class="row">
            <label data-i="toneMappingLabel">Tone mapping</label>
            <select id="tone-mapping" class="field">
              <option value="ACES" selected data-i="toneMappingACES">ACES</option>
              <option value="Linear" data-i="toneMappingLinear">Linear</option>
              <option value="Reinhard" data-i="toneMappingReinhard">Reinhard</option>
              <option value="Cineon" data-i="toneMappingCineon">Cineon</option>
              <option value="Neutral" data-i="toneMappingNeutral">Neutral</option>
              <option value="None" data-i="toneMappingNone">None</option>
            </select>
          </div>
          <div class="row">
            <button id="reset-render" class="btn secondary"><i class="fas fa-undo"></i><span data-i="btnReset">Reset</span></button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Directional light -->
      <details class="section" data-sec="dirlight">
        <summary><span class="summary-title"><i class="fas fa-sun"></i> <span data-i="directionalLightTitle">Directional light</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="intensityLabel">Intensity</label>
            <input id="dir-intensity" class="range" type="range" min="0" max="5" step="0.01" value="0.9" />
            <span class="small" id="dir-intensity-val">0.90</span>
          </div>
          <div class="row">
            <label data-i="angleLabel">Angle</label>
            <input id="dir-angle" class="range" type="range" min="0" max="360" step="1" value="34" />
            <span class="small" id="dir-angle-val">34°</span>
          </div>
          <div class="row">
            <label data-i="softnessLabel">Softness</label>
            <input id="dir-softness" class="range" type="range" min="0" max="4" step="0.1" value="1" />
            <span class="small" id="dir-softness-val">1.0</span>
          </div>
          <div class="row">
            <button id="reset-dir" class="btn secondary"><i class="fas fa-undo"></i><span data-i="btnReset">Reset</span></button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Environment -->
      <details class="section" data-sec="environment">
        <summary><span class="summary-title"><i class="fas fa-globe"></i> <span data-i="environmentTitle">Environment</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="envIntensityLabel">Env intensity</label>
            <input id="env-intensity" class="range" type="range" min="0" max="4" step="0.01" value="1" />
            <span class="small" id="env-intensity-val">1.00</span>
          </div>
          <div class="row">
            <button id="reset-env" class="btn secondary"><i class="fas fa-undo"></i><span data-i="btnReset">Reset</span></button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Gizmos & measurements -->
      <details class="section" data-sec="gizmos">
        <summary><span class="summary-title"><i class="fas fa-ruler-combined"></i> <span data-i="gizmosTitle">Gizmos & measurements</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label class="toggle"><input type="checkbox" id="toggle-transform"/><span data-i="gizmoToggle">Gizmo</span></label>
            <select id="transform-mode" class="field">
              <option value="translate" selected data-i="transformTranslate">Translate</option>
              <option value="rotate" data-i="transformRotate">Rotate</option>
              <option value="scale" data-i="transformScale">Scale</option>
            </select>
            <label class="toggle"><input type="checkbox" id="toggle-snap"/><span data-i="snapToggle">Snap</span></label>
          </div>
          <div class="row">
            <label data-i="deltaPosLabel">ΔPos</label><input id="snap-pos" class="field" type="number" step="0.01" value="0.1" style="width:80px" />
            <label data-i="deltaRotLabel">ΔRot°</label><input id="snap-rot" class="field" type="number" step="1" value="15" style="width:80px" />
            <label data-i="deltaScaleLabel">ΔScale</label><input id="snap-scale" class="field" type="number" step="0.01" value="0.1" style="width:80px" />
          </div>
          <div class="row">
            <button id="measure-toggle" class="btn" data-i="measureToggle">Measure</button>
            <button id="measure-clear" class="btn secondary" data-i="measureClear">Clear</button>
            <span class="tag" id="measure-out">—</span>
          </div>
          <div class="row">
            <button id="reset-gizmos" class="btn secondary"><i class="fas fa-undo"></i><span data-i="btnReset">Reset</span></button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Camera -->
      <details class="section" data-sec="camera">
        <summary><span class="summary-title"><i class="fas fa-camera"></i> <span data-i="cameraTitle">Camera</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row small">
            <label data-i="movementSensitivity">Movement sensitivity</label>
            <input id="movement-sensitivity" class="range" type="range" min="0.1" max="50" step="0.1" value="5.0" style="width:120px" />
            <span class="small" id="movement-sensitivity-val">5.0</span>
          </div>
          <div class="row" id="cam-presets">
            <button class="btn" data-view="front" data-i="camFront">Front</button>
            <button class="btn" data-view="back" data-i="camBack">Back</button>
            <button class="btn" data-view="left" data-i="camLeft">Left</button>
            <button class="btn" data-view="right" data-i="camRight">Right</button>
            <button class="btn" data-view="top" data-i="camTop">Top</button>
            <button class="btn" data-view="bottom" data-i="camBottom">Bottom</button>
            <button class="btn" data-view="iso" data-i="camIso">Iso</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Animations -->
      <details class="section" data-sec="anim">
        <summary><span class="summary-title"><i class="fas fa-play"></i> <span data-i="animTitle">Animations</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row anim-controls" id="anim-row">
            <select id="anim-select" class="field"></select>
            <button id="anim-playpause" class="btn ok icon-btn" title="Play"><i class="fas fa-play"></i><span data-i="animPlay" class="sr-only">Play</span></button>
            <button id="anim-stop" class="btn icon-btn" title="Stop"><i class="fas fa-stop"></i><span data-i="animStop" class="sr-only">Stop</span></button>
            <label class="toggle icon-btn" id="anim-loop-toggle" title="Loop"><input type="checkbox" id="anim-loop" checked /><i class="fas fa-redo"></i></label>
          </div>
          <div class="row">
            <input id="anim-progress" class="range" type="range" min="0" max="1" step="0.001" value="0" />
            <span class="small" id="anim-time">0.00 / 0.00s</span>
            <label class="row small anim-speed-control">
              <span data-i="animSpeed">Speed</span>
              <input id="anim-speed" class="field" type="number" step="0.25" min="0.25" max="3" value="1" />
              <span data-i="animSpeedUnit">x</span>
            </label>
          </div>
          <div class="small" data-i="animHint">By default animations do not play.</div>
        </div>
      </details>

      <!-- Collapsible: Debug -->
      <details class="section" data-sec="debug">
        <summary><span class="summary-title"><i class="fas fa-bug"></i> <span data-i="debugTitle">Debug</span></span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label class="toggle">
              <input type="checkbox" id="debug-log-toggle" />
              <i class="fas fa-terminal"></i>
              <span data-i="toggleDebugLog">Enable Debug Logging</span>
            </label>
          </div>
        </div>
      </details>
    </div>

    <script type="module">
      import Logger from './src/core/Logger.js';
      document.addEventListener('DOMContentLoaded', () => {
        const debugLogToggle = document.getElementById('debug-log-toggle');
        if (debugLogToggle) {
          Logger.setEnabled(debugLogToggle.checked);
        }
      });
    </script>

    <div class="split"></div>

    <div class="group scroll" style="min-height: 0">
      <label class="small" data-i="hotkeys">Hotkeys</label>
      <div class="row small">
        <span class="kbd">LMB</span> <span data-i="hkSelect">select</span>
        <span class="kbd">F</span> <span data-i="hkFocus">focus</span>
        <span class="kbd">R</span> <span data-i="hkReset">reset camera</span>
        <span class="kbd">Del</span> <span data-i="hkClearSel">clear selection</span>
      </div>
      <span class="small" data-i="movementSensitivityHint" title="Работает со всеми раскладками клавиатуры" style="display: block; margin-top: 4px;">🌐</span>
    </div>
  </aside>

  <aside id="scene-inspector" class="inspector right-0" aria-label="Scene Inspector">
    <header>
      <strong data-i="inspector">Scene</strong>
      <div class="row">
        <span class="tag" id="poly-count">—</span>
        <button class="btn" id="inspector-close" data-i="btnHideInspector">Hide</button>
      </div>
    </header>
    <div class="tree" id="tree"></div>
  </aside>

  <button class="open-inspector-tab" id="open-inspector" title="Inspector">☰</button>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="overlay" id="overlay">
    <div class="progress">
      <h3 id="progress-title" class="overlay-title" data-i="loadingTitle">Loading...</h3>
      <div class="meter indeterminate" id="meter"><i></i></div>
      <div class="small overlay-subtitle" id="progress-sub" data-i="awaitingData">Awaiting data...</div>
    </div>
  </div>

  <div class="debug" id="debug-bar">
    <div class="chip" id="filename-display"></div>
    <div class="chip"><b>FPS:</b> <span id="fps">—</span></div>
    <div class="chip"><b data-i="objects">Objects:</b> <span id="obj-count">—</span></div>
  </div>
    <script type="module">
        import Logger from './src/core/Logger.js';
        const toggle = document.getElementById('debug-log-toggle');
        if (toggle) {
            Logger.setEnabled(toggle.checked);
        }
    </script>
<script type="module">
  import { Application } from './src/core/Application.js';
  import { loadLanguage } from './src/i18n.js';

  document.addEventListener('DOMContentLoaded', async () => {
    const canvas = document.getElementById('viewport');
    const app = await Application.create(canvas);
    window.app = app; // Expose for debugging

    const langSelect = document.getElementById('lang');
    if (langSelect) {
      const userLang = navigator.language.startsWith('ru') ? 'ru' : 'en';
      langSelect.value = userLang;
      loadLanguage(userLang).then(() => {
        app.ui.applyLang(userLang);
      });
    }
  });
</script>
</body>
</html>