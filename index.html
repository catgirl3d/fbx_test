<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Viewer ‚Äî Pro</title>

  <!-- Import map for bare specifier "three" -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js"
    }
  }
  </script>

  <!-- FontAwesome icon font (used by inspector toggles) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- JSZip for ZIP texture loading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- TGA-js - standalone TGA loader for browser -->
  <script src="/src/utils/tga-js.js"></script>
  <script>console.debug('[index.html] TGALoader global:', typeof TGALoader !== 'undefined');</script>

  <link rel="stylesheet" href="src/style.css" />
</head>
<body class="preload">
  <div class="viewer-wrap" id="drop-zone" aria-label="3D Viewer">
    <canvas class="viewer-canvas" id="viewport" tabindex="0"></canvas>
  </div>

  <aside class="left-col" aria-label="Controls">
    <header>
      <span class="logo-dot" aria-hidden="true"></span>
      <h1 data-i="title">3D Viewer</h1>
      <select id="lang" class="field lang-select">
        <option value="en" data-i="lang_en">English</option>
        <option value="ru" data-i="lang_ru">–†—É—Å—Å–∫–∏–π</option>
      </select>
      <button id="theme-toggle" class="theme-switch" title="Theme">
        <span class="icon" id="theme-icon">üåû</span>
      </button>
    </header>

    <div class="group">
      <div class="toolbar">
        <label class="btn btn-primary">
          <input id="file-input" type="file" accept=".gltf,.glb,.fbx,.obj,.bin,.dae,.vrm,.zip" hidden />
          <i class="fas fa-upload"></i>
          <span data-i="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å</span>
        </label>
        <button id="clear-scene" class="btn danger btn-primary" data-i="btnClear">
          <i class="fas fa-trash"></i>
          <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
        </button>
      </div>

      <div class="split"></div>

      <div class="toolbar">
        <button id="reset-camera" class="btn secondary" data-i="btnFrame">
          <i class="fas fa-crosshairs"></i>
          <span>–ö –∫–∞–º–µ—Ä–µ</span>
        </button>
        <button id="reset-all" class="btn secondary" data-i="btnResetAll">
          <i class="fas fa-undo"></i>
          <span>–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</span>
        </button>
      </div>

      <div class="split"></div>

      <!-- Collapsible: Display -->
      <details class="section" data-sec="display" open>
        <summary><span class="summary-title" data-i="displayTitle"><i class="fas fa-eye"></i> Display</span><span class="chev">‚ñæ</span></summary>
        <div class="section-body">
          <div class="row">
            <label class="toggle"><input type="checkbox" id="toggle-shadows" /><i class="fas fa-sun"></i><span data-i="toggleShadows">–¢–µ–Ω–∏</span></label>
            <label class="toggle"><input type="checkbox" id="toggle-fxaa" checked /><i class="fas fa-magic"></i><span data-i="toggleFXAA">FXAA</span></label>
            <label class="toggle"><input type="checkbox" id="toggle-lightonly" /><i class="fas fa-lightbulb"></i><span data-i="toggleLight">–¢–æ–ª—å–∫–æ –æ—Å–≤–µ—â–µ–Ω–∏–µ</span></label>
            <label class="toggle"><input type="checkbox" id="toggle-grid" checked /><i class="fas fa-th"></i><span data-i="toggleGrid">–°–µ—Ç–∫–∞</span></label>
            <label class="toggle"><input type="checkbox" id="toggle-flipuv" /><i class="fas fa-arrows-alt-h"></i><span data-i="toggleFlipUV">–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å UV</span></label>
          </div>
        </div>
      </details>
  
      <!-- Collapsible: Background & HDRI -->
      <details class="section" data-sec="background">
        <summary><span class="summary-title" data-i="backgroundTitle"><i class="fas fa-image"></i> Background & HDRI</span><span class="chev">‚ñæ</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="bgLabel">–§–æ–Ω</label>
            <select id="bg-select" class="field">
              <option value="white" selected data-i="bgWhite">–ë–µ–ª—ã–π</option>
              <option value="lightgray" data-i="bgLightGray">–°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π</option>
              <option value="midgray" data-i="bgMidGray">–°—Ä–µ–¥–Ω–µ-—Å–µ—Ä—ã–π</option>
              <option value="darkgray" data-i="bgDarkGray">–¢—ë–º–Ω—ã–π</option>
              <option value="transparent" data-i="bgTransparent">–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π</option>
              <option value="custom" data-i="bgCustom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π</option>
            </select>
            <input id="bg-color" class="field" type="color" value="#ffffff" title="Custom" />
          </div>

          <div class="row">
            <label data-i="hdriLabel"><i class="fas fa-globe"></i> HDRI</label>
            <input class="field" type="text" id="hdri-url" placeholder="URL .hdr" />
            <button id="apply-hdri" class="btn" data-i="btnApply">
              <i class="fas fa-check"></i>
              <span data-i="btnApplyText">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
            </button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Textures & Materials -->
      <details class="section" data-sec="materials">
        <summary><span class="summary-title" data-i="materialsTitle"><i class="fas fa-palette"></i> Textures & Materials</span><span class="chev">‚ñæ</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="texturesLabel"><i class="fas fa-palette"></i> –¢–µ–∫—Å—Ç—É—Ä—ã</label>
            <input id="texture-input" type="file" accept=".zip" hidden />
            <label for="texture-input" class="btn" data-i="btnLoadTextures">
              <i class="fas fa-folder-open"></i>
              <span data-i="btnLoadTexturesText">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç—É—Ä—ã</span>
            </label>
            <button id="apply-textures" class="btn" data-i="btnApplyTextures">
              <i class="fas fa-paint-brush"></i>
              <span data-i="btnApplyTexturesText">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç—É—Ä—ã</span>
            </button>
          </div>

          <!-- Moved up: Material/Wireframe always visible -->
          <div class="row">
            <label data-i="matOverride"><i class="fas fa-cube"></i> –ú–∞—Ç–µ—Ä–∏–∞–ª</label>
            <select id="mat-override" class="field">
              <option value="none" selected data-i="matOriginal">–û—Ä–∏–≥–∏–Ω–∞–ª</option>
              <option value="standard" data-i="matStandard">Standard</option>
              <option value="phong" data-i="matPhong">Phong</option>
              <option value="basic" data-i="matBasic">Basic</option>
              <option value="normal" data-i="matNormal">Normal</option>
              <option value="toon" data-i="matToon">Toon</option>
            </select>
            <label class="toggle"><input type="checkbox" id="toggle-wireframe" /><i class="fas fa-project-diagram"></i><span data-i="wireframe">–ö–∞—Ä–∫–∞—Å</span></label>
          </div>
        </div>
      </details>


      <!-- Collapsible: Render -->
      <details class="section" data-sec="render">
        <summary><span class="summary-title" data-i="renderTitle"><i class="fas fa-paint-brush"></i> Render</span><span class="chev">‚ñæ</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="exposureLabel">Exposure</label>
            <input id="exposure" class="range" type="range" min="0" max="4" step="0.01" value="1" />
            <span class="small" id="exposure-val">1.00</span>
          </div>
          <div class="row">
            <label data-i="toneMappingLabel">Tone mapping</label>
            <select id="tone-mapping" class="field">
              <option value="ACES" selected data-i="toneMappingACES">ACES</option>
              <option value="Linear" data-i="toneMappingLinear">Linear</option>
              <option value="Reinhard" data-i="toneMappingReinhard">Reinhard</option>
              <option value="Cineon" data-i="toneMappingCineon">Cineon</option>
              <option value="Neutral" data-i="toneMappingNeutral">Neutral</option>
              <option value="None" data-i="toneMappingNone">None</option>
            </select>
          </div>
          <div class="row">
            <button id="reset-render" class="btn secondary" data-i="btnReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Directional light -->
      <details class="section" data-sec="dirlight">
        <summary><span class="summary-title" data-i="directionalLightTitle"><i class="fas fa-sun"></i> Directional light</span><span class="chev">‚ñæ</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="intensityLabel">Intensity</label>
            <input id="dir-intensity" class="range" type="range" min="0" max="5" step="0.01" value="0.9" />
            <span class="small" id="dir-intensity-val">0.90</span>
          </div>
          <div class="row">
            <label data-i="angleLabel">Angle</label>
            <input id="dir-angle" class="range" type="range" min="0" max="360" step="1" value="34" />
            <span class="small" id="dir-angle-val">34¬∞</span>
          </div>
          <div class="row">
            <label data-i="softnessLabel">Softness</label>
            <input id="dir-softness" class="range" type="range" min="0" max="4" step="0.1" value="1" />
            <span class="small" id="dir-softness-val">1.0</span>
          </div>
          <div class="row">
            <button id="reset-dir" class="btn secondary" data-i="btnReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Environment -->
      <details class="section" data-sec="environment">
        <summary><span class="summary-title" data-i="environmentTitle"><i class="fas fa-globe"></i> Environment</span><span class="chev">‚ñæ</span></summary>
        <div class="section-body">
          <div class="row">
            <label data-i="envIntensityLabel">Env intensity</label>
            <input id="env-intensity" class="range" type="range" min="0" max="4" step="0.01" value="1" />
            <span class="small" id="env-intensity-val">1.00</span>
          </div>
          <div class="row">
            <button id="reset-env" class="btn secondary" data-i="btnReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Gizmos & measurements -->
      <details class="section" data-sec="gizmos">
        <summary><span class="summary-title" data-i="gizmosTitle"><i class="fas fa-ruler-combined"></i> Gizmos & measurements</span><span class="chev">‚ñæ</span></summary>
        <div class="section-body">
          <div class="row">
            <label class="toggle"><input type="checkbox" id="toggle-transform"/><span data-i="gizmoToggle">Gizmo</span></label>
            <select id="transform-mode" class="field">
              <option value="translate" selected data-i="transformTranslate">Translate</option>
              <option value="rotate" data-i="transformRotate">Rotate</option>
              <option value="scale" data-i="transformScale">Scale</option>
            </select>
            <label class="toggle"><input type="checkbox" id="toggle-snap"/><span data-i="snapToggle">Snap</span></label>
          </div>
          <div class="row">
            <label data-i="deltaPosLabel">ŒîPos</label><input id="snap-pos" class="field" type="number" step="0.01" value="0.1" style="width:80px" />
            <label data-i="deltaRotLabel">ŒîRot¬∞</label><input id="snap-rot" class="field" type="number" step="1" value="15" style="width:80px" />
            <label data-i="deltaScaleLabel">ŒîScale</label><input id="snap-scale" class="field" type="number" step="0.01" value="0.1" style="width:80px" />
          </div>
          <div class="row">
            <button id="measure-toggle" class="btn" data-i="measureToggle">Measure</button>
            <button id="measure-clear" class="btn secondary" data-i="measureClear">Clear</button>
            <span class="tag" id="measure-out">‚Äî</span>
          </div>
          <div class="row">
            <button id="reset-gizmos" class="btn secondary" data-i="btnReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Camera -->
      <details class="section" data-sec="camera">
        <summary><span class="summary-title" data-i="cameraTitle"><i class="fas fa-camera"></i> Camera</span><span class="chev">‚ñæ</span></summary>
        <div class="section-body">
          <div class="row small">
            <label data-i="movementSensitivity">–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è</label>
            <input id="movement-sensitivity" class="range" type="range" min="0.1" max="50" step="0.1" value="5.0" style="width:120px" />
            <span class="small" id="movement-sensitivity-val">5.0</span>
          </div>
          <div class="row" id="cam-presets">
            <button class="btn" data-view="front" data-i="camFront">Front</button>
            <button class="btn" data-view="back" data-i="camBack">Back</button>
            <button class="btn" data-view="left" data-i="camLeft">Left</button>
            <button class="btn" data-view="right" data-i="camRight">Right</button>
            <button class="btn" data-view="top" data-i="camTop">Top</button>
            <button class="btn" data-view="bottom" data-i="camBottom">Bottom</button>
            <button class="btn" data-view="iso" data-i="camIso">Iso</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Animations -->
      <details class="section" data-sec="anim">
        <summary><span class="summary-title"><i class="fas fa-play"></i> <span data-i="animTitle">–ê–Ω–∏–º–∞—Ü–∏–∏</span></span><span class="chev">‚ñæ</span></summary>
        <div class="section-body">
          <div class="row anim-controls" id="anim-row">
            <select id="anim-select" class="field"></select>
            <button id="anim-playpause" class="btn ok icon-btn" title="Play"><i class="fas fa-play"></i><span data-i="animPlay" class="sr-only">Play</span></button>
            <button id="anim-stop" class="btn icon-btn" title="Stop"><i class="fas fa-stop"></i><span data-i="animStop" class="sr-only">Stop</span></button>
            <label class="toggle icon-btn" id="anim-loop-toggle" title="Loop"><input type="checkbox" id="anim-loop" checked /><i class="fas fa-redo"></i></label>
          </div>
          <div class="row">
            <input id="anim-progress" class="range" type="range" min="0" max="1" step="0.001" value="0" />
            <span class="small" id="anim-time">0.00 / 0.00s</span>
            <label class="row small anim-speed-control">
              <span data-i="animSpeed">–°–∫–æ—Ä–æ—Å—Ç—å</span>
              <input id="anim-speed" class="field" type="number" step="0.25" min="0.25" max="3" value="1" />
              <span data-i="animSpeedUnit">x</span>
            </label>
          </div>
          <div class="small" data-i="animHint">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è.</div>
        </div>
      </details>
    </div>

    <div class="split"></div>

    <div class="group scroll" style="min-height: 0">
      <label class="small" data-i="hotkeys">–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</label>
      <div class="row small">
        <span class="kbd">LMB</span> <span data-i="hkSelect">–≤—ã–±–æ—Ä</span>
        <span class="kbd">F</span> <span data-i="hkFocus">–∫ –æ–±—ä–µ–∫—Ç—É</span>
        <span class="kbd">R</span> <span data-i="hkReset">—Å–±—Ä–æ—Å –∫–∞–º–µ—Ä—ã</span>
        <span class="kbd">Del</span> <span data-i="hkClearSel">—Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</span>
      </div>
      <span class="small" data-i="movementSensitivityHint" title="–†–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ —Ä–∞—Å–∫–ª–∞–¥–∫–∞–º–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã" style="display: block; margin-top: 4px;">üåê</span>
    </div>
  </aside>

  <aside id="scene-inspector" class="inspector right-0" aria-label="Scene Inspector">
    <header>
      <strong data-i="inspectorTitle">–°—Ü–µ–Ω–∞</strong>
      <div class="row">
        <span class="tag" id="poly-count">‚Äî</span>
        <span class="tag" id="bbox-size" data-i="bboxSize">bbox: ‚Äî</span>
        <button class="btn" id="inspector-close" data-i="btnHideInspector">–°–∫—Ä—ã—Ç—å</button>
      </div>
    </header>
    <div class="tree" id="tree"></div>
  </aside>

  <button class="open-inspector-tab" id="open-inspector" title="Inspector">‚ò∞</button>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="overlay" id="overlay">
    <div class="progress">
      <h3 id="progress-title" data-i="loadingTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</h3>
      <div class="meter indeterminate" id="meter"><i></i></div>
      <div class="small" id="progress-sub" data-i="awaitingData">–û–∂–∏–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶</div>
    </div>
  </div>

  <div class="debug" id="debug-bar">
    <div class="chip" id="filename-display"></div>
    <div class="chip"><b>FPS:</b> <span id="fps">‚Äî</span></div>
    <div class="chip"><b data-i="objects">–û–±—ä–µ–∫—Ç—ã:</b> <span id="obj-count">‚Äî</span></div>
  </div>
<script type="module" src="./src/app.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const langSelect = document.getElementById('lang');
    if (langSelect) {
      // Set initial language based on browser or saved preference
      const userLang = navigator.language.startsWith('ru') ? 'ru' : 'en';
      langSelect.value = userLang;
      // The app.js will handle loading the language via ui.applyLang
    }
  });
</script>
</body>
</html>