<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Viewer — Pro</title>

  <!-- Import map for bare specifier "three" -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js"
    }
  }
  </script>

  <style>
    :root{
      /* Light theme (default) */
      --panel-w: 360px;
      --bg-page: #f5f7fc;
      --bg-panel: #ffffff;
      --text: #0b1220;
      --muted: #5b667a;
      --accent: #2563eb;
      --danger: #ef4444;
      --ok: #10b981;
      --border: #d9deea;
      --chip-bg:#fff;
      --chip-bd:#e6ebf7;
      --chip-tx:#344054;
      --toast-bg:#111827; --toast-bd:#1f2937; --toast-tx:#e5edff;
      --button-hover:#f6f8fe;
      --button-checked:#f3f7ff;
      --tree-sel-bg:#eef3ff; --tree-sel-bd:#c8d5ff;
      --progress-bg:#fff; --progress-bd:#e6ebf7; --meter-bg:#eef2fb; --meter-bd:#e1e7fb;
      --grid-c1:#8892a6; --grid-c2:#cbd5e1;
      --canvas-default:#ffffff; /* canvas scene background default (white) */
    }
    body.theme-dark{
      /* Dark theme overrides */
      --bg-page:#0b0d12;
      --bg-panel:#121520;
      --text:#e9eef5;
      --muted:#a9b3c7;
      --accent:#4da3ff;
      --danger:#ff5e7a;
      --ok:#4cd480;
      --border:#222736;
      --chip-bg:#0f1322; --chip-bd:#1b213d; --chip-tx:#b7c5e6;
      --toast-bg:#0f1528; --toast-bd:#1b2240; --toast-tx:#cfe0ff;
      --button-hover:#161a28;
      --button-checked:#0d1420;
      --tree-sel-bg:#1a2542; --tree-sel-bd:#2c3e6a;
      --progress-bg:#0f1322; --progress-bd:#1c2340; --meter-bg:#0b1020; --meter-bd:#1b2446;
      --grid-c1:#293347; --grid-c2:#1b2233;
      --canvas-default:#0b0d12;
    }

    html, body{ margin:0; padding:0; height:100%; background: var(--bg-page); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    /* avoid flicker: hide left panel until sections are initialized */
    body.preload .left-col{ visibility:hidden }

    .viewer-wrap{ position:fixed; inset:0; overflow:hidden; }
    canvas.viewer-canvas{ position:absolute; inset:0; display:block; outline: none; }

    .left-col{
      position: fixed; top: 0; left: 0; bottom: 0; width: var(--panel-w); max-width: 92vw;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      padding: 12px 12px 16px;
      display:flex; flex-direction:column; gap:12px; z-index: 30;
      box-shadow: 0 0 30px rgba(0,0,0,.06);
    }
    .left-col header{ display:flex; align-items:center; gap:10px; }
    .logo-dot{ width:10px; height:10px; border-radius:50%; background: var(--accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent); }
    .left-col h1{ font-size: 16px; margin:0; font-weight: 700; letter-spacing: .2px; }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn, .toggle{
      appearance:none; border:1px solid var(--border); background: var(--bg-panel); color: var(--text);
      padding: 8px 10px; border-radius: 10px; cursor: pointer; transition: .15s transform, .15s background, .15s border-color;
      font-size: 13px; line-height: 1; display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover, .toggle:hover{ background:var(--button-hover); border-color:color-mix(in srgb, var(--border) 60%, transparent); transform: translateY(-1px) }
    .btn.secondary{ background: color-mix(in srgb, var(--bg-panel) 90%, white); }
    .btn.danger{ border-color: color-mix(in srgb, var(--danger) 25%, var(--border)); background: color-mix(in srgb, var(--danger) 8%, var(--bg-panel)); color:color-mix(in srgb, var(--danger) 60%, black); }
    .btn.ok{ border-color:color-mix(in srgb, var(--ok) 25%, var(--border)); background:color-mix(in srgb, var(--ok) 8%, var(--bg-panel)); color:color-mix(in srgb, var(--ok) 65%, black); }
    .toggle input{ display:none; }
    .toggle:has(input:checked){ border-color:color-mix(in srgb, var(--accent) 30%, var(--border)); background:var(--button-checked); }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .row label{ font-size:12px; color: var(--muted) }
    .field{ background:var(--bg-panel); border:1px solid var(--border); border-radius: 8px; padding:6px 8px; color:var(--text) }
    .split{ height:1px; background:var(--border); opacity:.5; margin: 4px 0 }
    .group{ display:flex; flex-direction:column; gap:8px }
    .scroll{ overflow:auto; }
    .small{ font-size:12px; color: var(--muted) }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:var(--chip-bg); border:1px solid var(--chip-bd); border-radius:6px; padding:1px 6px; font-size:11px; color:var(--chip-tx) }

    /* Inspector */
    .inspector{
      position: fixed; top:0; right: calc(-1 * var(--panel-w)); bottom:0; width: var(--panel-w);
      background: var(--bg-panel);
      border-left:1px solid var(--border);
      transition: right .25s ease;
      z-index: 40; display:flex; flex-direction:column; box-shadow: 0 0 30px rgba(0,0,0,.06);
    }
    .inspector.right-0{ right: 0 }
    .inspector header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; gap:8px; border-bottom:1px solid var(--border) }
    .inspector .tree{ flex:1; overflow:auto; padding: 10px 8px; }
    .tag{ font-size:11px; padding: 2px 6px; border-radius: 999px; background:var(--chip-bg); border:1px solid var(--chip-bd); color:var(--chip-tx) }
    .tree ul{ list-style:none; padding-left: 14px; margin: 0 }
    .tree li{ margin: 2px 0 }
    .tree button{ background: none; border:1px solid transparent; color: var(--text); cursor: pointer; padding: 2px 6px; border-radius: 6px }
    .tree button:hover{ background:var(--button-hover); border-color:color-mix(in srgb, var(--border) 60%, transparent) }
    .tree .selected{ background:var(--tree-sel-bg); border-color:var(--tree-sel-bd) }

    .overlay{ position:fixed; inset:0; display:none; place-items:center; background: rgba(0,0,0,.6); z-index: 50; }
    .overlay.show{ display:grid }
    .progress{
      min-width: 280px; max-width: 60vw; background:var(--progress-bg); border:1px solid var(--progress-bd); border-radius: 12px; padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    .progress h3{ margin:0 0 8px 0; font-size:14px }
    .meter{ height: 8px; background: var(--meter-bg); border:1px solid var(--meter-bd); border-radius: 999px; overflow:hidden }
    .meter > i{ display:block; height:100%; width:0%; background: linear-gradient(90deg, #60a5fa, #93c5fd); transition: width .15s }
    .indeterminate{ position:relative; overflow:hidden }
    .indeterminate > i{ position:absolute; width:40%; left:-40%; animation: roll 1.2s infinite linear }
    @keyframes roll { to { left: 100% } }

    .toast{
      position:fixed; left: 12px; bottom: 12px; z-index: 60; padding: 10px 12px;
      background:var(--toast-bg); border:1px solid var(--toast-bd); color:var(--toast-tx); border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,.25);
      display:none;
    }
    .toast.show{ display:block }
    .debug{
      position:fixed; left:12px; right: calc(var(--panel-w) + 12px); bottom: 12px; z-index: 20;
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; pointer-events:none;
    }
    .chip{ pointer-events:auto; background:var(--chip-bg); border:1px solid var(--chip-bd); border-radius: 999px; padding: 6px 10px; font-size:12px; color:var(--chip-tx) }
    .chip b{ color:var(--text) }
    .open-inspector-tab{
      position: fixed; top: 50%; right: 0; transform: translateY(-50%);
      z-index: 35; padding: 8px 10px; border-radius: 10px 0 0 10px;
      background:var(--bg-panel); border:1px solid var(--border); border-right: none; cursor: pointer;
      box-shadow: 0 4px 16px rgba(0,0,0,.08);
    }
    .range{ width: 220px }
    .lang-select{ margin-left:auto }
    .theme-switch{
      margin-left:4px;
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border); background:var(--bg-panel); padding:6px 8px; border-radius:10px; cursor:pointer;
    }
    .theme-switch .icon{ width:16px; height:16px; display:inline-block }

    /* Accordion (native details) */
    details.section{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--bg-panel); }
    details.section + details.section{ margin-top:8px; }
    details.section > summary{
      list-style:none; cursor:pointer; padding:10px 12px; font-weight:700; font-size:12px;
      display:flex; align-items:center; justify-content:space-between; letter-spacing:.2px;
      border-bottom:1px solid var(--border); color: var(--text);
    }
    details.section > summary::-webkit-details-marker{ display:none }
    details.section[open] > summary{ background:var(--button-checked); }
    .summary-title{ display:flex; align-items:center; gap:8px }
    .summary-title::before{ content:""; width:3px; height:16px; border-radius:2px; background: color-mix(in srgb, var(--accent) 70%, transparent); }
    .chev{ opacity:.7; transition: transform .15s ease; }
    details.section[open] .chev{ transform: rotate(180deg) }
    .section-body{ padding:10px 12px; display:flex; flex-direction:column; gap:8px }
  </style>
</head>
<body class="preload">
  <div class="viewer-wrap" id="drop-zone" aria-label="3D Viewer">
    <canvas class="viewer-canvas" id="viewport" tabindex="0"></canvas>
  </div>

  <aside class="left-col" aria-label="Controls">
    <header>
      <span class="logo-dot" aria-hidden="true"></span>
      <h1 data-i="title">3D Viewer</h1>
      <button id="theme-toggle" class="theme-switch" title="Theme">
        <span class="icon" id="theme-icon">🌞</span>
        <span id="theme-label">Light</span>
      </button>
      <select id="lang" class="field lang-select">
        <option value="ru">Русский</option>
        <option value="en">English</option>
      </select>
    </header>

    <div class="group">
      <div class="toolbar">
        <label class="btn">
          <input id="file-input" type="file" accept=".gltf,.glb,.fbx,.obj,.bin,.dae,.vrm,.zip" hidden />
          <span data-i="btnLoad">Загрузить модель</span>
        </label>
        <button id="reset-camera" class="btn secondary" data-i="btnFrame">К камере</button>
        <button id="clear-scene" class="btn danger" data-i="btnClear">Очистить</button>
        <button id="reset-all" class="btn secondary" data-i="btnResetAll">Сбросить всё</button>
      </div>

      <div class="row">
        <label class="toggle"><input type="checkbox" id="toggle-shadows" /><span data-i="toggleShadows">Тени</span></label>
        <label class="toggle"><input type="checkbox" id="toggle-fxaa" checked /><span>FXAA</span></label>
        <label class="toggle"><input type="checkbox" id="toggle-lightonly" /><span data-i="toggleLight">Только освещение</span></label>
        <label class="toggle"><input type="checkbox" id="toggle-grid" checked /><span data-i="toggleGrid">Сетка</span></label>
      </div>

      <div class="row">
        <label data-i="bgLabel">Фон</label>
        <select id="bg-select" class="field">
          <option value="white" selected>Белый</option>
          <option value="lightgray">Светло-серый</option>
          <option value="midgray">Средне-серый</option>
          <option value="darkgray">Тёмный</option>
          <option value="transparent">Прозрачный</option>
          <option value="custom">Произвольный</option>
        </select>
        <input id="bg-color" class="field" type="color" value="#ffffff" title="Custom" />
      </div>

      <div class="row">
        <label>HDRI</label>
        <input class="field" type="text" id="hdri-url" placeholder="URL .hdr" />
        <button id="apply-hdri" class="btn" data-i="btnApply">Применить</button>
      </div>

      <!-- Moved up: Material/Wireframe always visible -->
      <div class="row">
        <label data-i="matOverride">Материал</label>
        <select id="mat-override" class="field">
          <option value="none" selected>Оригинал</option>
          <option value="standard">Standard</option>
          <option value="phong">Phong</option>
          <option value="basic">Basic</option>
          <option value="normal">Normal</option>
          <option value="toon">Toon</option>
        </select>
        <label class="toggle"><input type="checkbox" id="toggle-wireframe" /><span data-i="wireframe">Каркас</span></label>
      </div>

      <div class="split"></div>

      <!-- Collapsible: Render -->
      <details class="section" data-sec="render">
        <summary><span class="summary-title">Render</span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label>Exposure</label>
            <input id="exposure" class="range" type="range" min="0" max="4" step="0.01" value="1" />
            <span class="small" id="exposure-val">1.00</span>
          </div>
          <div class="row">
            <label>Tone mapping</label>
            <select id="tone-mapping" class="field">
              <option value="ACES" selected>ACES</option>
              <option value="Linear">Linear</option>
              <option value="Reinhard">Reinhard</option>
              <option value="Cineon">Cineon</option>
              <option value="Neutral">Neutral</option>
              <option value="None">None</option>
            </select>
          </div>
          <div class="row">
            <button id="reset-render" class="btn secondary" data-i="btnReset">Сбросить</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Directional light -->
      <details class="section" data-sec="dirlight">
        <summary><span class="summary-title">Directional light</span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label>Intensity</label>
            <input id="dir-intensity" class="range" type="range" min="0" max="5" step="0.01" value="0.9" />
            <span class="small" id="dir-intensity-val">0.90</span>
          </div>
          <div class="row">
            <label>Angle</label>
            <input id="dir-angle" class="range" type="range" min="0" max="360" step="1" value="34" />
            <span class="small" id="dir-angle-val">34°</span>
          </div>
          <div class="row">
            <label>Softness</label>
            <input id="dir-softness" class="range" type="range" min="0" max="4" step="0.1" value="1" />
            <span class="small" id="dir-softness-val">1.0</span>
          </div>
          <div class="row">
            <button id="reset-dir" class="btn secondary" data-i="btnReset">Сбросить</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Environment -->
      <details class="section" data-sec="environment">
        <summary><span class="summary-title">Environment</span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label>Env intensity</label>
            <input id="env-intensity" class="range" type="range" min="0" max="4" step="0.01" value="1" />
            <span class="small" id="env-intensity-val">1.00</span>
          </div>
          <div class="row">
            <button id="reset-env" class="btn secondary" data-i="btnReset">Сбросить</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Gizmos & measurements -->
      <details class="section" data-sec="gizmos">
        <summary><span class="summary-title">Gizmos & measurements</span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row">
            <label class="toggle"><input type="checkbox" id="toggle-transform"/><span>Gizmo</span></label>
            <select id="transform-mode" class="field">
              <option value="translate" selected>Translate</option>
              <option value="rotate">Rotate</option>
              <option value="scale">Scale</option>
            </select>
            <label class="toggle"><input type="checkbox" id="toggle-snap"/><span>Snap</span></label>
          </div>
          <div class="row">
            <label>ΔPos</label><input id="snap-pos" class="field" type="number" step="0.01" value="0.1" style="width:80px" />
            <label>ΔRot°</label><input id="snap-rot" class="field" type="number" step="1" value="15" style="width:80px" />
            <label>ΔScale</label><input id="snap-scale" class="field" type="number" step="0.01" value="0.1" style="width:80px" />
          </div>
          <div class="row">
            <button id="measure-toggle" class="btn">Measure</button>
            <button id="measure-clear" class="btn secondary">Clear</button>
            <span class="tag" id="measure-out">—</span>
          </div>
          <div class="row">
            <button id="reset-gizmos" class="btn secondary" data-i="btnReset">Сбросить</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Camera -->
      <details class="section" data-sec="camera">
        <summary><span class="summary-title">Camera</span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row" id="cam-presets">
            <button class="btn" data-view="front">Front</button>
            <button class="btn" data-view="back">Back</button>
            <button class="btn" data-view="left">Left</button>
            <button class="btn" data-view="right">Right</button>
            <button class="btn" data-view="top">Top</button>
            <button class="btn" data-view="bottom">Bottom</button>
            <button class="btn" data-view="iso">Iso</button>
          </div>
        </div>
      </details>

      <!-- Collapsible: Animations -->
      <details class="section" data-sec="anim">
        <summary><span class="summary-title" data-i="animTitle">Анимации</span><span class="chev">▾</span></summary>
        <div class="section-body">
          <div class="row" id="anim-row">
            <select id="anim-select" class="field" style="min-width:200px"></select>
            <button id="anim-playpause" class="btn ok" data-i="animPlay">Пуск</button>
            <button id="anim-stop" class="btn" data-i="animStop">Стоп</button>
            <label class="toggle"><input type="checkbox" id="anim-loop" checked /><span data-i="animLoop">Зациклить</span></label>
            <label class="row small">
              <span data-i="animSpeed">Скорость</span>
              <input id="anim-speed" class="field" type="number" step="0.25" min="0.25" max="3" value="1" style="width:70px" />
              <span>x</span>
            </label>
          </div>
          <div class="row">
            <input id="anim-progress" class="range" type="range" min="0" max="1" step="0.001" value="0" />
            <span class="small" id="anim-time">0.00 / 0.00s</span>
          </div>
          <div class="small" data-i="animHint">По умолчанию анимация не проигрывается.</div>
        </div>
      </details>
    </div>

    <div class="split"></div>

    <div class="group scroll" style="min-height: 0">
      <label class="small" data-i="hotkeys">Горячие клавиши</label>
      <div class="row small">
        <span class="kbd">LMB</span> <span data-i="hkSelect">выбор</span>
        <span class="kbd">F</span> <span data-i="hkFocus">к объекту</span>
        <span class="kbd">R</span> <span data-i="hkReset">сброс камеры</span>
        <span class="kbd">Del</span> <span data-i="hkClearSel">снять выделение</span>
      </div>
    </div>
  </aside>

  <aside id="scene-inspector" class="inspector right-[-360px]" aria-label="Scene Inspector">
    <header>
      <strong data-i="inspector">Сцена</strong>
      <div class="row">
        <span class="tag" id="poly-count">—</span>
        <span class="tag" id="bbox-size">bbox: —</span>
        <button class="btn" id="inspector-close" data-i="btnHideInspector">Скрыть</button>
      </div>
    </header>
    <div class="tree" id="tree"></div>
  </aside>

  <button class="open-inspector-tab" id="open-inspector" title="Inspector">☰</button>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="overlay" id="overlay">
    <div class="progress">
      <h3 id="progress-title">Загрузка…</h3>
      <div class="meter indeterminate" id="meter"><i></i></div>
      <div class="small" id="progress-sub">Ожидаем данные…</div>
    </div>
  </div>

  <div class="debug" id="debug-bar">
    <div class="chip"><b>FPS:</b> <span id="fps">—</span></div>
    <div class="chip"><b data-i="objects">Объекты:</b> <span id="obj-count">—</span></div>
  </div>
<script type="module" src="./src/app.js"></script>
</body>
</html>
